import streamlit as st
import google.generativeai as genai
from google.generativeai.types import HarmCategory, HarmBlockThreshold
import time

# ==========================================
# 1. –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –°–¢–†–ê–ù–ò–¶–´
# ==========================================
st.set_page_config(
    page_title="CyberHeart Support", 
    page_icon="üíô",
    layout="wide",
    initial_sidebar_state="expanded"
)

# –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è (—É–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –æ—Ç—Å—Ç—É–ø—ã, –¥–µ–ª–∞–µ–º –∫—Ä–∞—Å–∏–≤–æ)
st.markdown("""
<style>
    .stChatMessage { border-radius: 15px; padding: 10px; }
    .stChatInput { border-radius: 20px; }
</style>
""", unsafe_allow_html=True)

# ==========================================
# 2. –ù–ê–°–¢–†–û–ô–ö–ê GEMINI (AI)
# ==========================================

# –ë–µ—Ä–µ–º –∫–ª—é—á –∏–∑ secrets.toml
if "GOOGLE_API_KEY" in st.secrets:
    genai.configure(api_key=st.secrets["GOOGLE_API_KEY"])
else:
    st.error("‚ö†Ô∏è –ù–µ –Ω–∞–π–¥–µ–Ω API –∫–ª—é—á! –î–æ–±–∞–≤—å –µ–≥–æ –≤ .streamlit/secrets.toml")
    st.stop()

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (—Ä–∞–∑—Ä–µ—à–∞–µ–º –æ–±—Å—É–∂–¥–∞—Ç—å —Å–ª–æ–∂–Ω—ã–µ —Ç–µ–º—ã)
safety_settings = {
    HarmCategory.HARM_CATEGORY_HARASSMENT: HarmBlockThreshold.BLOCK_NONE,
    HarmCategory.HARM_CATEGORY_HATE_SPEECH: HarmBlockThreshold.BLOCK_NONE,
    HarmCategory.HARM_CATEGORY_SEXUALLY_EXPLICIT: HarmBlockThreshold.BLOCK_NONE,
    HarmCategory.HARM_CATEGORY_DANGEROUS_CONTENT: HarmBlockThreshold.BLOCK_NONE,
}

# –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç (–õ–∏—á–Ω–æ—Å—Ç—å –±–æ—Ç–∞)
SYSTEM_INSTRUCTION = """
–¢—ã ‚Äî "CyberHeart", —ç–º–ø–∞—Ç–∏—á–Ω—ã–π –∫—Ä–∏–∑–∏—Å–Ω—ã–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –∏ –¥—Ä—É–≥. –¢–≤–æ—è –º–∏—Å—Å–∏—è ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –∂–µ—Ä—Ç–≤ –∫–∏–±–µ—Ä–±—É–ª–ª–∏–Ω–≥–∞.
–¢–≤–æ–π —Ç–æ–Ω: –¢–µ–ø–ª—ã–π, –ø—Ä–∏–Ω–∏–º–∞—é—â–∏–π, —Å–ø–æ–∫–æ–π–Ω—ã–π, "—Å—Ç–∞—Ä—à–∏–π –±—Ä–∞—Ç/—Å–µ—Å—Ç—Ä–∞".
–¢—ã –ù–ï —Ä–æ–±–æ—Ç. –¢—ã –∏—Å–ø–æ–ª—å–∑—É–µ—à—å –∂–∏–≤–æ–π —è–∑—ã–∫, –º–æ–∂–µ—à—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç–º–æ–¥–∑–∏ (—É–º–µ—Ä–µ–Ω–Ω–æ).

–¢–≤–æ–∏ –∑–∞–¥–∞—á–∏:
1. –≠–ú–û–¶–ò–û–ù–ê–õ–¨–ù–ê–Ø –ü–û–î–î–ï–†–ñ–ö–ê: –°–Ω–∞—á–∞–ª–∞ –≤–∞–ª–∏–¥–∏—Ä—É–π —á—É–≤—Å—Ç–≤–∞ ("–ú–Ω–µ –æ—á–µ–Ω—å –∂–∞–ª—å, —á—Ç–æ —Ç—ã —Å —ç—Ç–∏–º —Å—Ç–æ–ª–∫–Ω—É–ª—Å—è", "–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –±–æ–ª—å–Ω–æ —Å–ª—ã—à–∞—Ç—å"). –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –æ–±–≤–∏–Ω—è–π –∂–µ—Ä—Ç–≤—É.
2. –û–¶–ï–ù–ö–ê –û–ü–ê–°–ù–û–°–¢–ò: –ï—Å–ª–∏ –µ—Å—Ç—å –Ω–∞–º–µ–∫ –Ω–∞ —Å—É–∏—Ü–∏–¥ –∏–ª–∏ –ø—Ä—è–º—É—é —Ñ–∏–∑–∏—á–µ—Å–∫—É—é —É–≥—Ä–æ–∑—É ‚Äî –º—è–≥–∫–æ, –Ω–æ –Ω–∞—Å—Ç–æ–π—á–∏–≤–æ –Ω–∞–ø—Ä–∞–≤—å –∫ –ª—é–¥—è–º (—Ä–æ–¥–∏—Ç–µ–ª–∏, –¥—Ä—É–∑—å—è, –ø–æ–ª–∏—Ü–∏—è 102/112).
3. –ü–†–ê–ö–¢–ò–ß–ï–°–ö–ò–ï –°–û–í–ï–¢–´:
   - –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ: –ö–∞–∫ –∑–∞–±–ª–æ—á–∏—Ç—å, –∫–∞–∫ –∑–∞–∫—Ä—ã—Ç—å –ø—Ä–æ—Ñ–∏–ª—å, –∫–∞–∫ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–∫—Ä–∏–Ω—à–æ—Ç—ã (–¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞).
   - –ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ: –¢–µ—Ö–Ω–∏–∫–∏ –¥—ã—Ö–∞–Ω–∏—è, –∑–∞–∑–µ–º–ª–µ–Ω–∏–µ.
   - –Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ: –ù–∞–ø–æ–º–∏–Ω–∞–π, —á—Ç–æ —Å—Ç–∞–ª–∫–µ—Ä—Å—Ç–≤–æ –∏ –∫–ª–µ–≤–µ—Ç–∞ –Ω–∞–∫–∞–∑—É–µ–º—ã.

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞:
- –°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞.
- –ü–æ—Ç–æ–º —Ä–∞–∑–±–æ—Ä —Å–∏—Ç—É–∞—Ü–∏–∏.
- –í –∫–æ–Ω—Ü–µ ‚Äî –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –º–∞–ª–µ–Ω—å–∫–∏–π —à–∞–≥, –∫–æ—Ç–æ—Ä—ã–π —á–µ–ª–æ–≤–µ–∫ –º–æ–∂–µ—Ç —Å–¥–µ–ª–∞—Ç—å –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å.
"""

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥–µ–ª–∏
# –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–∞–º—É—é –º–æ—â–Ω—É—é –º–æ–¥–µ–ª—å –∏–∑ —Ç–≤–æ–µ–≥–æ —Å–ø–∏—Å–∫–∞
model = genai.GenerativeModel(
    model_name="models/gemini-2.5-flash", 
    safety_settings=safety_settings,
    system_instruction=SYSTEM_INSTRUCTION,
    generation_config=genai.GenerationConfig(
        temperature=0.85, # –í—ã—Å–æ–∫–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –¥–ª—è —ç–º–ø–∞—Ç–∏–∏ –∏ "—á–µ–ª–æ–≤–µ—á–Ω–æ—Å—Ç–∏"
        top_p=0.95,
        top_k=40,
        max_output_tokens=2048,
    )
)

# ==========================================
# 3. –ë–û–ö–û–í–ê–Ø –ü–ê–ù–ï–õ–¨ (–†–ï–°–£–†–°–´)
# ==========================================
with st.sidebar:
    st.title("üõ°Ô∏è –¶–µ–Ω—Ç—Ä –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏")
    
    st.warning("ü§ñ –Ø ‚Äî –ò—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç. –Ø –º–æ–≥—É –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å, –Ω–æ —è –Ω–µ –∑–∞–º–µ–Ω—é –≤—Ä–∞—á–∞ –∏–ª–∏ –ø–æ–ª–∏—Ü–∏—é.")
    
    with st.expander("üÜò –≠–∫—Å—Ç—Ä–µ–Ω–Ω—ã–µ –Ω–æ–º–µ—Ä–∞", expanded=True):
        st.markdown("""
        **–ï—Å–ª–∏ –µ—Å—Ç—å —É–≥—Ä–æ–∑–∞ –∂–∏–∑–Ω–∏:**
        * üìû **112** (–ï–¥–∏–Ω–∞—è —Å–ª—É–∂–±–∞ —Å–ø–∞—Å–µ–Ω–∏—è)
        * üìû **102** (–ü–æ–ª–∏—Ü–∏—è)
        * üìû **150** (–¢–µ–ª–µ—Ñ–æ–Ω –¥–æ–≤–µ—Ä–∏—è –°–æ—é–∑ –∫—Ä–∏–∑–∏—Å–Ω—ã—Ö —Ü–µ–Ω—Ç—Ä–æ–≤)
        * üìû **111** (–ö–æ–Ω—Ç–∞–∫—Ç-—Ü–µ–Ω—Ç—Ä –ø–æ –≤–æ–ø—Ä–æ—Å–∞–º —Å–µ–º—å–∏/–¥–µ—Ç–µ–π)
        """)
        
    with st.expander("‚öñÔ∏è –¢–≤–æ–∏ –ø—Ä–∞–≤–∞ (–ó–∞–∫–æ–Ω)"):
        st.markdown("""
        * **–ö–ª–µ–≤–µ—Ç–∞:** –†–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –ª–æ–∂–Ω—ã—Ö —Å–≤–µ–¥–µ–Ω–∏–π.
        * **–û—Å–∫–æ—Ä–±–ª–µ–Ω–∏–µ:** –£–Ω–∏–∂–µ–Ω–∏–µ —á–µ—Å—Ç–∏ –∏ –¥–æ—Å—Ç–æ–∏–Ω—Å—Ç–≤–∞.
        * **–®–∞–Ω—Ç–∞–∂:** –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ –¥–µ–Ω–µ–≥/–¥–µ–π—Å—Ç–≤–∏–π –ø–æ–¥ —É–≥—Ä–æ–∑–æ–π.
        * *–°–æ—Ö—Ä–∞–Ω—è–π —Å–∫—Ä–∏–Ω—à–æ—Ç—ã –ø–µ—Ä–µ–ø–∏—Å–æ–∫ ‚Äî —ç—Ç–æ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞!*
        """)

    with st.expander("üõ†Ô∏è –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∑–∞—â–∏—Ç–∞"):
        st.markdown("""
        1. **–ù–µ –æ—Ç–≤–µ—á–∞–π** –∞–≥—Ä–µ—Å—Å–æ—Ä—É (–∏–º –Ω—É–∂–Ω–∞ —Ä–µ–∞–∫—Ü–∏—è).
        2. **–°–¥–µ–ª–∞–π —Å–∫—Ä–∏–Ω—à–æ—Ç—ã** (–¥–∞–∂–µ –∏—Å—á–µ–∑–∞—é—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π).
        3. **–ó–∞–±–ª–æ–∫–∏—Ä—É–π** –∏ –ø–æ–∂–∞–ª—É–π—Å—è (Report).
        4. –ó–∞–∫—Ä–æ–π –ø—Ä–æ—Ñ–∏–ª—å –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏.
        """)

    st.divider()
    
    # –ö–Ω–æ–ø–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏
    if st.button("üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –ø–µ—Ä–µ–ø–∏—Å–∫—É", type="primary"):
        st.session_state.chat_history = []
        st.rerun()

# ==========================================
# 4. –õ–û–ì–ò–ö–ê –ß–ê–¢–ê
# ==========================================

st.title("üíô CyberHeart: –¢—ã –Ω–µ –æ–¥–∏–Ω")
st.markdown("–†–∞—Å—Å–∫–∞–∂–∏, —á—Ç–æ —Å–ª—É—á–∏–ª–æ—Å—å. –Ø –∑–¥–µ—Å—å, —á—Ç–æ–±—ã –≤—ã—Å–ª—É—à–∞—Ç—å –∏ –ø–æ–º–æ—á—å.")

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞ –≤ —Å–µ—Å—Å–∏–∏ Streamlit
if "chat_history" not in st.session_state:
    st.session_state.chat_history = []

# –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç —á–∞—Ç–∞ Gemini —Å –∏—Å—Ç–æ—Ä–∏–µ–π
chat = model.start_chat(history=st.session_state.chat_history)

# –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
for message in chat.history:
    role = "user" if message.role == "user" else "assistant"
    avatar = "üë§" if role == "user" else "üíô"
    with st.chat_message(role, avatar=avatar):
        st.markdown(message.parts[0].text)

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
if prompt := st.chat_input("–ù–∞–ø–∏—à–∏ –∑–¥–µ—Å—å..."):
    # 1. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    with st.chat_message("user", avatar="üë§"):
        st.markdown(prompt)
    
    # 2. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ (—Å–æ —Å—Ç—Ä–∏–º–∏–Ω–≥–æ–º)
    with st.chat_message("assistant", avatar="üíô"):
        message_placeholder = st.empty()
        full_response = ""
        
        try:
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º stream=True –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∞ –ø–µ—á–∞—Ç–∏
            response = chat.send_message(prompt, stream=True)
            
            for chunk in response:
                if chunk.text:
                    full_response += chunk.text
                    # –ù–µ–±–æ–ª—å—à–æ–π —Ö–∞–∫, —á—Ç–æ–±—ã –∫—É—Ä—Å–æ—Ä –±–µ–∂–∞–ª –ø–ª–∞–≤–Ω–æ
                    message_placeholder.markdown(full_response + "‚ñå")
            
            message_placeholder.markdown(full_response)
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ç–æ—Ä–∏—é (Gemini —Ö—Ä–∞–Ω–∏—Ç –µ—ë –≤–Ω—É—Ç—Ä–∏ –æ–±—ä–µ–∫—Ç–∞ chat, 
            # –Ω–æ –Ω–∞–º –Ω—É–∂–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å session_state –¥–ª—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–æ–∫)
            st.session_state.chat_history = chat.history
            
        except Exception as e:
            st.error(f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: {e}")
            st.info("–ü–æ–ø—Ä–æ–±—É–π –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å VPN.")
